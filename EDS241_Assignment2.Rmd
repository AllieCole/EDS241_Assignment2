---
title: "EDS241: Assignment 2"
author: "Allie Cole"
date: '`r format(Sys.time(), "%m/%d/%Y")`'
output: 
  pdf_document:
    toc: false
    number_sections: yes
header-includes:
  - \setlength{\parindent}{1em}
  - \usepackage{float}
--- 
  
``` {r setup, echo = FALSE, message = FALSE, warning = FALSE}

# set default chunk options
knitr::opts_chunk$set(fig.width = 4, fig.height = 3, 
                      echo = TRUE, message = FALSE, warning = FALSE)


# load packages
packages=c("stargazer", "here", "tidyr", "dplyr","stringr", "janitor", 
           "cowplot", "ggplot2", "tinytex", "datasets", "tibble", "kableExtra", "estimatr", "broom")

for (i in packages) {
  if (require(i,character.only=TRUE)==FALSE) {
    install.packages(i,repos='http://cran.us.r-project.org')
  }
  else {
    require(i,character.only=TRUE)
  }
}

#devtools::install_github('rstudio/rmarkdown')
options(scipen=4) # not scientific notation


```


# Clean and plot data

\noindent The following code loads and cleans the data.

```{r , include=TRUE}

# Load data

library(readxl)
data_nox <- read_excel("NBP.xls", sheet = 1, na = "NA") %>% 
  clean_names() 

```

The data included in the file NBP.xls are: fips (fips code
identifying each county), NBP (indicator =1 if the county was regulated under the NOx Budget
Program), PctBlack (fraction of the county population that is African American), and
Dnox_masstons (change in total NOx emissions from all power plants in a county between
2000 and 2008 (in tons)). Note that the NBP market was in effect in 212 of the 485 counties in
the sample from 2003 to 2008, so the 2008-2000 change give us a sense of the program’s
effect on emissions. If emissions of NOx from power plants declined in a county, then
Dnox_masstons should be negative.

# Homework Questions 

### (a) Make a histogram depicting the distribution of Dnox_masstons.

```{r}
ggplot(data = data_nox, aes(x = dnox_masstons)) +
  geom_histogram(aes(fill = as.factor(nbp), position = 'dodge')) +
  theme_cowplot(14) +
  labs(x = "Change in total NOx emissions between
2000 and 2008  (tons)", 
       y = "Count", 
        fill = "NBP")
```

### (b) Create an indicator =1 if the county has PctBlack above the sample median, and =0
otherwise (in the rest of the assignment, I refer to this variable as ‘D’). What is the average of
PctBlack for counties above the median, i.e. counties for which D=1?

```{r}
median_pctblack <- median(data_nox$pct_black)

data_nox <- data_nox %>% 
  mutate(D = if_else(pct_black > median_pctblack, 1, 0)) #creating a new column that will have a 1 if the median is larger than the number and a zero if not

average <- data_nox %>% 
  select(pct_black, D) %>% 
  filter(D == 1)

mean <- mean(average$pct_black)
```
The average of PctBlack for counties above the median is `r mean`

### (c) Estimate a regression of Dnox_masstons on NBP. Interpret the estimated intercept and the
coefficient on NBP.

```{r}
nbp_model <- lm(data = data_nox, dnox_masstons ~ nbp)

table1 <- broom::tidy(nbp_model) %>% 
  knitr::kable() %>% 
  kableExtra::kable_styling(full_width = FALSE, 
                latex_options = "HOLD_position")
table1
```
The intercept here is the average rate of change from 2000 to 2008 in all nox emissions within counties that are unregulated, so the predicted change in for those unregulated counties is -3.62 tons (when nbp is zero). The coefficient predicts that the change in annual NOx emissions was on average -3.92 ton higher for counties that were regulated, when compared to those that were unregulated. We know that a negative dnox_masstons gives us a decrease in NOx, so from this we can say that the NOx Budget Program was working and annual Nox emmisions were decreaing by 3.92 tons when the county is regulated. 

### (d) Create an interaction between the variables NBP and D. Estimate a regression of
Dnox_masstons on NBP, D, and this interaction. Interpret each estimated regression coefficient,
including the intercept.

```{r}
nbp_d_model <- lm_robust(data = data_nox, dnox_masstons ~ nbp + D + nbp:D)


table2 <- broom::tidy(nbp_d_model) %>% 
  knitr::kable() %>% 
  kableExtra::kable_styling(full_width = FALSE, 
                latex_options = "HOLD_position")

table2
```
The intercept here shows the average rate of change of all nox emissions within a given county between 2000 to 2008 for a county that is unregulated and with a percentage of the African American population below the sample median is -2.42 tons. Or in terms of the variables, when nbp is zero and the pct_black is below 19.31 and D=0, the change in NOx emmissions in the counties between 2000-2008 will be -2.42 tons


The estimate for nbp is saying that when everything is held constant, counties that were regulated under the Nox budget plan (nbp = 1) will have an average change from all power plants in the counties between 2000- 2008 of -7.14 tons compared to the intercept (Nbp= 0, pct_black = below 19.31 and D=0). 

The estimate for D is saying that on average counties that have an average of African American populations higher that the median (19.31) will have a change in NOx emissions from all power plants in the counties between 2000 to 2008 of -2.59 compared to the intercept (Nbp= 0, pct_black = below 19.31 and D=0).

The estimate of nbp:D is the intersection between the implantation of the policy and the percent black above sample mean. This is saying that the NOx budget program raised the NOx emissions from all power plants in the counties between 2000- 2008 by 6.37 tons in counties that have an average percent of the African American population above 19.31% compared to counties that have an average percent of the African American population below 19.31%.

### (e) What is the predicted Dnox_masstons in a county that was not regulated under NBP and
where PctBlack is above the sample median (i.e., where D=1)? Report the 95% confidence
interval for this prediction. Make sure to use “heteroskedasticity-robust” standard errors.


```{r}
model_e <- lm_robust(data = data_nox, dnox_masstons ~nbp + D)

predict_data <- data.frame(nbp = c(0), D = c(1))

predict(model_e, newdata = predict_data, se.fit = T, interval = 'confidence')
```

The predicted Dnox_masstons in a county that was not regulated under NBP and
where PctBlack is above the sample median is -3.52 tons, with a 95% confidence interval, using heterskedasticity robust standard errors, of -4.82 and -2.21 tons. 





